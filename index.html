<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kalkulator + World Currency Index</title>
<style>
  *{box-sizing:border-box;font-family:Arial, sans-serif}
  body{background:#0f172a;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;color:#fff;padding:24px}
  .app{width:360px;background:#020617;padding:18px;border-radius:14px}
  .display{height:56px;background:#020617;color:#22c55e;font-size:26px;text-align:right;padding:8px;border-radius:10px;pointer-events:none}
  .buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
  button{height:46px;border:none;border-radius:12px;font-size:15px;cursor:pointer;background:#1e293b;color:#e5e7eb}
  .operator{background:#2563eb}
  .equal{background:#22c55e;color:#020617;grid-column:span 2}
  .danger{background:#dc2626}
  select{width:100%;padding:8px;border-radius:8px;margin-top:10px}
  .section{margin-top:15px;border-top:1px solid #334155;padding-top:10px}
  .index-list div{display:flex;justify-content:space-between;padding:8px;border-radius:8px;margin-top:8px;font-size:14px;align-items:center}
  /* warna indikator: hijau = naik, merah = turun, abu = tetap */
  .up{background:#0f5132;color:#bbf7d0}
  .down{background:#4c0f0f;color:#fee2e2}
  .same{background:#172033;color:#cbd5e1}
  .rate{font-weight:700;margin-left:8px}
  .delta{font-size:12px;opacity:0.9;margin-left:8px}
  .small{font-size:12px;color:#9ca3af;margin-top:6px}
  .error-box{background:#dc2626;color:white;padding:8px;border-radius:6px;margin-top:8px;display:none}
  .hint{font-size:12px;color:#9ca3af;margin-top:8px}
  .spark { width:70px; height:18px; display:inline-block; vertical-align:middle; margin-right:8px; }
</style>
</head>
<body>
  <div class="app">
    <div id="display" class="display">0</div>

    <!-- Kalkulator -->
    <div class="buttons">
      <button class="danger" onclick="clearAll()">C</button>
      <button onclick="del()">‚å´</button>
      <button onclick="append('%')">%</button>
      <button class="operator" onclick="append('/')">√∑</button>

      <button onclick="append('7')">7</button>
      <button onclick="append('8')">8</button>
      <button onclick="append('9')">9</button>
      <button class="operator" onclick="append('*')">√ó</button>

      <button onclick="append('4')">4</button>
      <button onclick="append('5')">5</button>
      <button onclick="append('6')">6</button>
      <button class="operator" onclick="append('-')">‚àí</button>

      <button onclick="append('1')">1</button>
      <button onclick="append('2')">2</button>
      <button onclick="append('3')">3</button>
      <button class="operator" onclick="append('+')">+</button>

      <button onclick="append('0')">0</button>
      <button onclick="append('.')">.</button>
      <button class="equal" onclick="calculate()">=</button>
    </div>

    <!-- Konversi -->
    <div class="section">
      <select id="currencySelect"></select>
      <button onclick="convert()">Convert IDR</button>
      <div id="convertHint" class="small">Masukkan jumlah IDR lalu pilih mata uang dan tekan Convert</div>
    </div>

    <!-- World Index -->
    <div class="section">
      <b>üåç World Currency Index (Base IDR)</b>
      <div id="index" class="index-list"></div>
      <div id="updateInfo" class="small"></div>
      <div id="errorBox" class="error-box"></div>
      <div id="snapshotHint" class="hint"></div>
    </div>
  </div>

  <script>
  // CONFIG
  const API_KEY = "7bf955733d797e7f6e318c49";
  const BASE = "IDR";
  const CURRENCIES = ["USD","EUR","JPY","GBP","AUD","CAD","CHF","CNY","SGD","MYR"];
  const HISTORY_LENGTH = 12; // jumlah snapshot untuk sparkline

  // STATE
  let expression = "";
  let rates = {};
  let previousSnapshot = JSON.parse(localStorage.getItem('previousSnapshot')) || null;
  let rateHistory = JSON.parse(localStorage.getItem('rateHistory')) || {}; // { USD: [..], EUR: [...] }

  const display = document.getElementById("display");
  const indexBox = document.getElementById("index");
  const currencySelect = document.getElementById("currencySelect");
  const updateInfo = document.getElementById("updateInfo");
  const errorBox = document.getElementById("errorBox");
  const snapshotHint = document.getElementById("snapshotHint");

  // Kalkulator helpers
  function append(v){ if(display.innerText === "0" && v !== ".") expression = ""; expression += v; display.innerText = expression; }
  function del(){ expression = expression.slice(0,-1); display.innerText = expression || "0"; }
  function calculate(){ try{ const expr = expression.replace(/%/g, '/100'); expression = eval(expr).toString(); display.innerText = expression; }catch(e){ display.innerText = "Error"; expression = ""; } }
  function clearAll(){ expression = ""; display.innerText = "0"; }

  function showError(msg){
    errorBox.style.display = "block";
    errorBox.innerText = msg;
    indexBox.innerHTML = `<div class="down">Gagal mengambil data</div>`;
  }

  // Sparkline generator (mengembalikan string SVG)
  function sparklineSVG(arr, trend){
    // arr: array angka (ascending time), trend: 'up'|'down'|'same'
    const w = 70, h = 18, pad = 4;
    if(!arr || arr.length < 2){
      const color = '#94a3b8'; // abu
      return `<svg class="spark" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg"><line x1="${pad}" y1="${h/2}" x2="${w-pad}" y2="${h/2}" stroke="${color}" stroke-width="2" stroke-linecap="round"/></svg>`;
    }
    // gunakan numbers
    const nums = arr.map(n => Number(n));
    const min = Math.min(...nums);
    const max = Math.max(...nums);
    const range = max - min || 1;
    // buat path
    const step = (w - pad*2) / (nums.length - 1);
    let d = '';
    nums.forEach((v,i)=>{
      const x = pad + i * step;
      // y: invert (0 top)
      const y = pad + (1 - (v - min) / range) * (h - pad*2);
      d += (i===0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
    });
    const color = trend === 'up' ? '#bbf7d0' : (trend === 'down' ? '#fecaca' : '#94a3b8');
    return `<svg class="spark" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
      <path d="${d}" fill="none" stroke="${color}" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
    </svg>`;
  }

  // Fetch + snapshot + history logic
  async function fetchRates(){
    errorBox.style.display = "none";
    snapshotHint.innerText = '';
    try{
      const res = await fetch(`https://v6.exchangerate-api.com/v6/${API_KEY}/latest/${BASE}`);
      const data = await res.json().catch(()=>null);

      if(!res.ok){
        const msg = data && data['error-type'] ? data['error-type'] : `HTTP ${res.status}`;
        showError(`API HTTP Error: ${msg}`);
        return;
      }
      if(!data || data.result !== "success"){
        const msg = data && data['error-type'] ? data['error-type'] : 'Unknown API error';
        showError(`API Error: ${msg}`);
        return;
      }

      const newTime = data.time_last_update_utc;
      const newRates = data.conversion_rates || {};

      // previousRates available jika previousSnapshot ada & waktunya berbeda
      let previousRates = null;
      if(previousSnapshot && previousSnapshot.time && previousSnapshot.time !== newTime){
        previousRates = previousSnapshot.rates;
      }

      // update rateHistory (hanya jika waktu berubah) -> push newRates
      if(!previousSnapshot || previousSnapshot.time !== newTime){
        // untuk setiap currency, push value baru
        CURRENCIES.forEach(c=>{
          const val = newRates[c];
          if(val === undefined) return;
          rateHistory[c] = rateHistory[c] || [];
          // hindari menambah duplicate terakhir (mis. saat reload tanpa update)
          const last = rateHistory[c].length ? Number(rateHistory[c][rateHistory[c].length-1]) : null;
          if(last === null || Number(val) !== last){
            rateHistory[c].push(Number(val));
            if(rateHistory[c].length > HISTORY_LENGTH) rateHistory[c].shift();
          }
        });
        localStorage.setItem('rateHistory', JSON.stringify(rateHistory));
      }

      // set current rates (untuk convert)
      rates = newRates;

      // update UI
      updateIndex(newRates, previousRates, rateHistory);
      if(!previousRates){
        snapshotHint.innerText = 'Indikator naik/turun butuh snapshot sebelumnya. Tunggu update API berikutnya atau gunakan simulasi (lihat instruksi).';
      }

      // simpan snapshot baru
      previousSnapshot = { time: newTime, rates: newRates };
      localStorage.setItem('previousSnapshot', JSON.stringify(previousSnapshot));

      updateSelect();
      renderUpdateInfo(newTime);

    }catch(err){
      console.error('Fetch error', err);
      showError(`Gagal mengambil data: ${err.message || err}`);
    }
  }

  // updateIndex menggunakan currentRates, previousRates (atau null), dan history
  function updateIndex(currentRates, previousRates, history){
    indexBox.innerHTML = '';
    CURRENCIES.forEach(cur=>{
      const now = currentRates && currentRates[cur] !== undefined ? Number(currentRates[cur]) : undefined;
      const prev = previousRates && previousRates[cur] !== undefined ? Number(previousRates[cur]) : null;
      let cls = 'same', icon = '‚ûñ', deltaText = '';

      if(prev !== null && !isNaN(prev) && now !== undefined && !isNaN(now)){
        const diff = now - prev;
        const pct = prev ? (diff / prev) * 100 : 0;
        if(diff > 0){ cls = 'up'; icon = 'üìà'; }
        else if(diff < 0){ cls = 'down'; icon = 'üìâ'; }
        deltaText = `${diff >= 0 ? '+' : ''}${diff.toFixed(6)} (${pct >= 0 ? '+' : ''}${pct.toFixed(3)}%)`;
      }

      // get history array for sparkline
      const hist = history && Array.isArray(history[cur]) ? history[cur] : [];
      // determine trend color: based on last diff (if hist has >=2)
      let trend = 'same';
      if(hist.length >= 2){
        const last = hist[hist.length-1];
        const prevh = hist[hist.length-2];
        if(Number(last) > Number(prevh)) trend = 'up';
        else if(Number(last) < Number(prevh)) trend = 'down';
      }

      const svg = sparklineSVG(hist, trend);

      const row = document.createElement('div');
      row.className = cls;
      // inline background fallback
      if(cls === 'up') row.style.backgroundColor = '#0f5132';
      else if(cls === 'down') row.style.backgroundColor = '#4c0f0f';
      else row.style.backgroundColor = '#172033';

      row.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="spark">${svg}</span>
          <div style="display:flex;flex-direction:column;">
            <span style="font-weight:600">${cur}</span>
            <span style="font-size:12px;color:#9ca3af">${now !== undefined && !isNaN(now) ? now.toFixed(6) : '‚Äî'}</span>
          </div>
        </div>
        <div style="text-align:right;min-width:90px">
          <div style="font-size:12px;color:rgba(255,255,255,0.85)">${deltaText || ' '}</div>
          <div style="margin-top:4px">${icon}</div>
        </div>
      `;
      indexBox.appendChild(row);
    });

    const info = document.createElement('div');
    info.className = 'same';
    info.style.marginTop = '8px';
    info.style.padding = '6px';
    info.innerText = 'Update harian (API Free) ‚Äî perubahan berdasarkan snapshot terakhir';
    indexBox.appendChild(info);
  }

  function updateSelect(){
    if(currencySelect.children.length) return;
    CURRENCIES.forEach(c=>{
      const o = document.createElement('option');
      o.value = c; o.textContent = c; currencySelect.appendChild(o);
    });
  }

  function convert(){
    const idr = parseFloat(display.innerText);
    if(isNaN(idr)){ display.innerText = 'Masukkan angka'; setTimeout(()=>{ display.innerText = '0'; expression = ''; },1200); return; }
    const cur = currencySelect.value;
    if(!rates || !rates[cur]){ display.innerText = 'Rates belum siap'; return; }
    const result = (idr * rates[cur]);
    display.innerText = result.toFixed(6) + ' ' + cur;
    expression = '';
  }

  function renderUpdateInfo(timeStr){
    updateInfo.innerText = timeStr ? `Last API update (UTC): ${timeStr}` : 'Belum ada update API';
  }

  // START
  fetchRates();
  const INTERVAL_MS = 60000; // 1 menit (ubah bila perlu)
  setInterval(fetchRates, INTERVAL_MS);
  </script>
</body>
</html>
